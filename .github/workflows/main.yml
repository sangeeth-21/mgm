name: 🚀 Deploy website on push

on:
  push:
    branches: [ main ]  # Only trigger on main branch pushes

jobs:
  web-deploy:
    name: 🎉 Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent hanging deployments
    
    steps:
    - name: 🚚 Get latest code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full git history

    - name: 🛠️ Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'  # Cache node_modules for faster builds

    - name: 📦 Install dependencies
      run: npm ci --prefer-offline  # Clean install from lockfile
      
    - name: 🔨 Build Project
      run: npm run build
      env:
        NODE_ENV: production  # Ensure production builds

    - name: 🗑️ Clean unnecessary files
      run: |
        rm -rf node_modules/ .git/ .github/
        find . -name '*.map' -delete

    - name: 📤 Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.ftp_server }}
        username: ${{ secrets.ftp_name }}
        password: ${{ secrets.ftp_password }}
        protocol: ftps  # More secure than plain FTP
        secure: true
        passive: true  # Helps with firewall issues
        server-dir: './public_html/'  # Default cPanel directory
        local-dir: './dist/'  # Only deploy built files
        exclude: |
          *.md
          *.log
          .env*
          .git*
          .github/
          node_modules/
      env:
        FTP_DEPLOY_DEBUG: 'true'  # Enable verbose logging